<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.mapper.VideoMapper">

    <resultMap id="VideoMap" type="com.kh.dto.VideoDTO">
        <result column="video_number" property="videoNumber"/>
        <result column="chapter_number" property="chapterNumber"/>
        <result column="class_number" property="classNumber"/>
        <result column="video_title" property="videoTitle" jdbcType="VARCHAR"/>
        <result column="video_id" property="videoId" jdbcType="VARCHAR"/>
        <result column="video_duration" property="videoDuration"/>
        <result column="video_order_number" property="videoOrderNumber"/>
        <result column="video_create_time" property="videoCreateTime"/>
    </resultMap>

    <!-- 해당 챕터의 영상 조회 -->
    <select id="selectVideo" parameterType="int" resultMap="VideoMap">
        SELECT 
            video_number, 
            chapter_number, 
            video_title, 
            video_id, 
            video_duration, 
            video_order_number, 
            video_create_time
        FROM VIDEO
        WHERE chapter_number = #{chapterNumber}
        ORDER BY video_order_number ASC
    </select>

    <!-- 유튜브 영상 정보 저장 -->
    <insert id="insertVideo" parameterType="com.kh.dto.VideoDTO">
        INSERT INTO VIDEO (video_number, chapter_number, video_title, video_id, video_duration, video_order_number, video_create_time)
        VALUES (VIDEO_NUMBER_SEQ.NEXTVAL, #{chapterNumber}, #{videoTitle}, #{videoId}, #{videoDuration}, 
               (SELECT COALESCE(MAX(video_order_number), 0) + 1 FROM VIDEO WHERE chapter_number = #{chapterNumber}), 
                SYSDATE)
    </insert>

    <!-- 특정 videoNumber로 영상 조회 -->
    <select id="getVideoByNumber" parameterType="int" resultMap="VideoMap">
        SELECT 
            v.video_number, 
            v.chapter_number, 
            ch.class_number,
            cl.title AS classTitle,  
            ch.chapter_name AS chapterTitle,
            v.video_title, 
            v.video_id, 
            v.video_duration, 
            v.video_order_number, 
            v.video_create_time
        FROM VIDEO v
        JOIN CHAPTER ch ON v.chapter_number = ch.chapter_number
        JOIN CLASS cl ON ch.class_number = cl.class_number
        WHERE v.video_number = #{videoNumber}
    </select>


    <!-- 같은 챕터 내에서 이전 영상 찾기 -->
    <select id="getPrevVideoNumber" parameterType="java.util.Map" resultType="int">
        SELECT MAX(v.video_number) 
        FROM VIDEO v
        WHERE v.chapter_number = #{chapterNumber} 
        AND v.video_number <![CDATA[<]]> #{videoNumber}
    </select>

    <!-- 같은 챕터 내에서 다음 영상 찾기 -->
    <select id="getNextVideoNumber" parameterType="java.util.Map" resultType="int">
        SELECT MIN(v.video_number) 
        FROM VIDEO v
        WHERE v.chapter_number = #{chapterNumber} 
        AND v.video_number <![CDATA[>]]> #{videoNumber}
    </select>

    <!-- 현재 강의 내에서 이전 챕터 찾기 -->
    <select id="getPrevChapter" parameterType="java.util.Map" resultType="int">
        SELECT MAX(c.chapter_number) 
        FROM CHAPTER c
        WHERE c.class_number = #{classNumber} 
        AND c.chapter_number <![CDATA[<]]> #{chapterNumber}
    </select>

    <!-- 현재 강의 내에서 다음 챕터 찾기 -->
    <select id="getNextChapter" parameterType="java.util.Map" resultType="int">
        SELECT MIN(c.chapter_number) 
        FROM CHAPTER c
        WHERE c.class_number = #{classNumber} 
        AND c.chapter_number <![CDATA[>]]> #{chapterNumber}
    </select>

    <!-- 이전 챕터의 마지막 영상 찾기 -->
    <select id="getLastVideoOfChapter" parameterType="java.util.Map" resultType="int">
        SELECT MAX(v.video_number) 
        FROM VIDEO v
        JOIN CHAPTER c ON v.chapter_number = c.chapter_number
        WHERE c.class_number = #{classNumber}
        AND c.chapter_number = #{chapterNumber}
    </select>

    <!-- 다음 챕터의 첫 번째 영상 찾기 -->
    <select id="getFirstVideoOfChapter" parameterType="java.util.Map" resultType="int">
        SELECT MIN(v.video_number) 
        FROM VIDEO v
        JOIN CHAPTER c ON v.chapter_number = c.chapter_number
        WHERE c.class_number = #{classNumber}
        AND c.chapter_number = #{chapterNumber}
    </select>

</mapper>