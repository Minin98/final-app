<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.mapper.ClassMapper">

    <!-- DTO 매핑 -->
    <resultMap type="com.kh.dto.ClassDTO" id="classMap">
        <id column="class_number" property="classNumber" />
        <result column="uno" property="uno" />
        <result column="title" property="title" />
        <result column="description" property="description" jdbcType="CLOB"/>
        <result column="category" property="category" />
        <result column="create_time" property="createTime" />
        <result column="update_time" property="updateTime" />
        <result column="thumbnail" property="thumbnail" />
        <result column="rate" property="rate" />
        <result column="name" property="name"/>
    </resultMap>

    <select id="selectClass" parameterType="map" resultType="com.kh.dto.ClassDTO">
        SELECT *
        FROM CLASS
        WHERE CLASS_NUMBER = #{classNumber}
    </select>

    <select id="selectLatestClasses" resultMap="classMap">
    SELECT 
    c.class_number,
    c.title,
    c.description,
    c.category,
    c.create_time,
    c.update_time,
    c.thumbnail,
    c.rate,
    c.uno,
    u.name
FROM CLASS c
JOIN USERS u ON c.uno = u.uno
ORDER BY c.create_time DESC
FETCH FIRST 3 ROWS ONLY
</select>

    <select id="getAllClasses" resultMap="classMap">
        SELECT *
        FROM CLASS
        ORDER BY create_time DESC
    </select> 
 
    <!-- 강의목록 조회 카테고리 및 정렬 조건을 적용 -->
    <select id="selectClassList" resultMap="classMap">
        SELECT c.*, u.name 
        FROM CLASS c
        JOIN USERS u ON c.uno = u.uno
        <where>
            <if test="category != null and category != '전체'">
                AND c.category = #{category}
            </if>
        </where>
        <choose>
            <when test="sort = '최신순'">
                ORDER BY c.create_time DESC
            </when>
            <when test="sort = '평점순'">
                ORDER BY c.rate DESC
            </when>
            <otherwise>
                ORDER BY c.create_time DESC
            </otherwise>
        </choose>
    </select>

    <select id="searchClasses" resultMap="classMap">
    SELECT c.class_number, c.title, c.description, c.category, 
           c.create_time, c.update_time, c.thumbnail, c.rate, 
           c.uno, u.name
    FROM CLASS c
    JOIN USERS u ON c.uno = u.uno
    <where>
        <if test="searchKeyword != null and searchKeyword != ''">
    AND (LOWER(c.title) LIKE '%' || LOWER(#{searchKeyword}) || '%')
</if>

        <if test="category != null and category != '전체'">
            AND c.category = #{category}
        </if>
    </where>
    <choose>
        <when test="sort = '최신순'">
            ORDER BY c.create_time DESC
        </when>
        <when test="sort = '평점순'">
            ORDER BY c.rate DESC
        </when>
        <otherwise>
            ORDER BY c.create_time DESC
        </otherwise>
    </choose>
</select>


</mapper>